<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCN Model & Interpretability Analysis Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #e67e22;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 5px solid #e67e22;
            padding-left: 15px;
        }
        h3 {
            color: #555;
            margin-top: 30px;
        }
        .section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .confusion-matrix {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 10px;
            max-width: 400px;
            margin: 20px auto;
            font-size: 1.1em;
        }
        .cm-cell {
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
        }
        .cm-header {
            background-color: #e67e22;
            color: white;
            font-weight: bold;
        }
        .cm-tn { background-color: #2ecc71; color: white; }
        .cm-fp { background-color: #f39c12; color: white; }
        .cm-fn { background-color: #e74c3c; color: white; }
        .cm-tp { background-color: #27ae60; color: white; }
        .feature-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .feature-table th {
            background-color: #e67e22;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        .feature-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        .feature-table tr:hover {
            background-color: #f8f9fa;
        }
        .feature-name {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #e74c3c;
        }
        .rank {
            font-weight: bold;
            color: #7f8c8d;
            text-align: center;
        }
        .group-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .group-current { background-color: #e3f2fd; color: #1976d2; }
        .group-recent { background-color: #f3e5f5; color: #7b1fa2; }
        .group-advanced { background-color: #fff3e0; color: #e65100; }
        .group-geo { background-color: #e8f5e9; color: #388e3c; }
        .group-dialog { background-color: #fce4ec; color: #c2185b; }
        .summary-box {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        .warning-box {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        .info-box {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .bar-chart {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .bar-label {
            width: 200px;
            font-weight: bold;
        }
        .bar-container {
            flex: 1;
            background-color: #ecf0f1;
            height: 30px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e67e22, #d35400);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        img {
            width: 100%;
            max-width: 1200px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Temporal Convolutional Network (TCN) Model & Interpretability Report</h1>
    <p><strong>Dataset:</strong> V3 Enhanced (71 features) | <strong>Model:</strong> TCN (Temporal Convolutional Network) | <strong>Date:</strong> 2024</p>

    <!-- MODEL PERFORMANCE -->
    <div class="section">
        <h2>Model Performance</h2>
        
        <div class="info-box">
            <strong>Dataset Information:</strong><br>
            Train: 202,357 samples (9.25% churn) | Test: 34,160 samples (9.84% churn)<br>
            Features: 71 | Optimal Threshold: 0.497 | Best Validation AUC: 0.9241
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">AUC-ROC</div>
                <div class="metric-value">0.9109</div>
                <div class="metric-label">Excellent discrimination</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Precision</div>
                <div class="metric-value">0.5619</div>
                <div class="metric-label">56.19% of predicted churners actually churn</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Recall</div>
                <div class="metric-value">0.6776</div>
                <div class="metric-label">67.76% of churners identified</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">F1 Score</div>
                <div class="metric-value">0.6143</div>
                <div class="metric-label">Balanced performance metric</div>
            </div>
        </div>

        <h3>Confusion Matrix</h3>
        <p><strong>Note:</strong> TCN makes predictions at the client level (one prediction per client sequence), not at the sample level. 
        The confusion matrix below shows results for 17,493 test clients.</p>
        <div class="confusion-matrix">
            <div></div>
            <div class="cm-cell cm-header">Predicted: No Churn</div>
            <div class="cm-cell cm-header">Predicted: Churn</div>
            
            <div class="cm-cell cm-header">Actual: No Churn</div>
            <div class="cm-cell cm-tn">14,502<br><small>True Negatives</small></div>
            <div class="cm-cell cm-fp">1,034<br><small>False Positives</small></div>
            
            <div class="cm-cell cm-header">Actual: Churn</div>
            <div class="cm-cell cm-fn">631<br><small>False Negatives</small></div>
            <div class="cm-cell cm-tp">1,326<br><small>True Positives</small></div>
        </div>

        <div class="info-box">
            <strong>Confusion Matrix Verification:</strong><br>
            Total clients: 14,502 + 1,034 + 631 + 1,326 = <strong>17,493</strong><br>
            Actual churned: 631 + 1,326 = <strong>1,957</strong> (11.19%)<br>
            Actual not churned: 14,502 + 1,034 = <strong>15,536</strong> (88.81%)<br>
            Predicted churn: 1,034 + 1,326 = <strong>2,360</strong> (13.5%)<br>
            Predicted no churn: 14,502 + 631 = <strong>15,133</strong> (86.5%)
        </div>

        <div class="summary-box">
            <strong>Performance Summary:</strong> The TCN model achieves strong discrimination (AUC-ROC 0.91) with excellent precision (56.2%) 
            and good recall (67.8%). At the optimal threshold of 0.497, the model correctly identifies 67.8% of churners (1,326 out of 1,957) 
            while maintaining 56.2% precision, meaning more than half of predicted churners actually churn. Out of 2,360 clients predicted to churn, 
            1,326 actually churn and 1,034 are false positives.
        </div>

        <h3>Model Architecture</h3>
        <table class="feature-table">
            <tr>
                <td><strong>Architecture</strong></td>
                <td>Temporal Convolutional Network (TCN)</td>
            </tr>
            <tr>
                <td><strong>Hidden Dimension</strong></td>
                <td>128</td>
            </tr>
            <tr>
                <td><strong>Number of Layers</strong></td>
                <td>2</td>
            </tr>
            <tr>
                <td><strong>Kernel Size</strong></td>
                <td>2</td>
            </tr>
            <tr>
                <td><strong>Dropout</strong></td>
                <td>0.3</td>
            </tr>
            <tr>
                <td><strong>Learning Rate</strong></td>
                <td>0.0005</td>
            </tr>
            <tr>
                <td><strong>Batch Size</strong></td>
                <td>128</td>
            </tr>
            <tr>
                <td><strong>Weight Decay</strong></td>
                <td>0.001</td>
            </tr>
            <tr>
                <td><strong>Loss Function</strong></td>
                <td>Focal Loss (alpha=0.25, gamma=2.0)</td>
            </tr>
            <tr>
                <td><strong>Optimizer</strong></td>
                <td>AdamW</td>
            </tr>
        </table>
    </div>

    <!-- COMPARISON WITH LIGHTGBM -->
    <div class="section">
        <h2>Model Comparison: TCN vs LightGBM</h2>
        <table class="feature-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>LightGBM</th>
                    <th>TCN</th>
                    <th>Difference</th>
                    <th>Winner</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>AUC-ROC</strong></td>
                    <td>0.9138</td>
                    <td>0.9109</td>
                    <td>-0.0029</td>
                    <td>LightGBM</td>
                </tr>
                <tr>
                    <td><strong>Precision</strong></td>
                    <td>0.5025</td>
                    <td>0.5619</td>
                    <td>+0.0594</td>
                    <td style="color: #27ae60; font-weight: bold;">TCN (+11.8%)</td>
                </tr>
                <tr>
                    <td><strong>Recall</strong></td>
                    <td>0.6830</td>
                    <td>0.6776</td>
                    <td>-0.0054</td>
                    <td>LightGBM</td>
                </tr>
                <tr>
                    <td><strong>F1 Score</strong></td>
                    <td>0.5790</td>
                    <td>0.6143</td>
                    <td>+0.0353</td>
                    <td style="color: #27ae60; font-weight: bold;">TCN (+6.1%)</td>
                </tr>
            </tbody>
        </table>

        <div class="info-box">
            <strong>Key Finding:</strong> TCN outperforms LightGBM on precision (+11.8%) and F1 score (+6.1%), making it better 
            for scenarios where precision is critical (e.g., when intervention costs are high). LightGBM has slightly better 
            AUC-ROC and recall, but TCN's superior precision makes it more practical for churn prediction.
        </div>
    </div>

    <!-- PERMUTATION IMPORTANCE -->
    <div class="section">
        <h2>Feature Importance: Permutation Importance</h2>
        <p>Permutation importance measures how much the model's performance degrades when a feature is randomly shuffled. 
        Higher absolute values indicate more important features.</p>

        <h3>Top 25 Features by Permutation Importance</h3>
        <img src="tcn_interpretability/permutation_importance_top25.png" alt="Permutation Importance Top 25">

        <table class="feature-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Feature Name</th>
                    <th>Combined Importance</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="rank">1</td>
                    <td class="feature-name">curr_trx_count</td>
                    <td>1.000</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">2</td>
                    <td class="feature-name">curr_trx_amount_sum</td>
                    <td>0.737</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">3</td>
                    <td class="feature-name">curr_trx_amount_mean</td>
                    <td>0.414</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">4</td>
                    <td class="feature-name">curr_trx_amount_std</td>
                    <td>0.344</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">5</td>
                    <td class="feature-name">curr_trx_days_active</td>
                    <td>0.308</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">6</td>
                    <td class="feature-name">curr_trx_event_types</td>
                    <td>0.299</td>
                    <td><span class="group-badge group-current">Current Month</span></td>
                </tr>
                <tr>
                    <td class="rank">7</td>
                    <td class="feature-name">recent_trx_count</td>
                    <td>0.294</td>
                    <td><span class="group-badge group-recent">Recent 3 Months</span></td>
                </tr>
                <tr>
                    <td class="rank">8</td>
                    <td class="feature-name">recent_trx_amount_sum</td>
                    <td>0.282</td>
                    <td><span class="group-badge group-recent">Recent 3 Months</span></td>
                </tr>
                <tr>
                    <td class="rank">9</td>
                    <td class="feature-name">recent_trx_amount_mean</td>
                    <td>0.247</td>
                    <td><span class="group-badge group-recent">Recent 3 Months</span></td>
                </tr>
                <tr>
                    <td class="rank">10</td>
                    <td class="feature-name">recent_trx_amount_std</td>
                    <td>0.219</td>
                    <td><span class="group-badge group-recent">Recent 3 Months</span></td>
                </tr>
            </tbody>
        </table>

        <div class="info-box">
            <strong>Key Insight:</strong> The combined importance (permutation + gradient attribution) shows that <strong>current month transaction features</strong> 
            dominate the top positions, with <code>curr_trx_count</code> being the most important feature. This aligns with the ablation study showing 
            current month features have the highest impact. Recent 3-month features also rank highly, providing important context.
        </div>
    </div>

    <!-- ABLATION STUDY -->
    <div class="section">
        <h2>Ablation Study: Feature Group Contribution</h2>
        <p>This analysis measures the impact of removing entire feature groups on model performance. 
        Higher impact values indicate more important feature groups.</p>

        <img src="tcn_interpretability/ablation_study.png" alt="Ablation Study">

        <table class="feature-table">
            <thead>
                <tr>
                    <th>Feature Group</th>
                    <th>Number of Features</th>
                    <th>AUC Impact</th>
                    <th>Remaining AUC</th>
                    <th>Interpretation</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Current Month</strong></td>
                    <td>7</td>
                    <td style="color: #e74c3c; font-weight: bold;">-0.0378</td>
                    <td>0.8731</td>
                    <td>Most critical group - removing it drops AUC by 3.78%</td>
                </tr>
                <tr>
                    <td><strong>Recent 3 Months</strong></td>
                    <td>13</td>
                    <td style="color: #e74c3c; font-weight: bold;">-0.0340</td>
                    <td>0.8769</td>
                    <td>Very important - provides context for current activity</td>
                </tr>
                <tr>
                    <td><strong>Advanced Time-Series</strong></td>
                    <td>22</td>
                    <td style="color: #f39c12; font-weight: bold;">-0.0106</td>
                    <td>0.9004</td>
                    <td>Moderate impact - temporal patterns add value</td>
                </tr>
                <tr>
                    <td><strong>Geo</strong></td>
                    <td>16</td>
                    <td style="color: #27ae60;">+0.0005</td>
                    <td>0.9114</td>
                    <td>Minimal impact - slightly improves when removed (noise)</td>
                </tr>
                <tr>
                    <td><strong>Dialog</strong></td>
                    <td>13</td>
                    <td style="color: #27ae60;">+0.0037</td>
                    <td>0.9146</td>
                    <td>Negative impact - removing improves performance (likely sparse/noisy)</td>
                </tr>
            </tbody>
        </table>

        <div class="summary-box">
            <strong>Key Findings:</strong>
            <ul>
                <li><strong>Current Month features</strong> are the most critical, with a 3.78% AUC drop when removed</li>
                <li><strong>Recent 3 Months features</strong> are also very important (3.40% drop)</li>
                <li><strong>Advanced Time-Series features</strong> contribute meaningfully (1.06% drop)</li>
                <li><strong>Geo and Dialog features</strong> have minimal or negative impact, likely due to sparse data</li>
            </ul>
        </div>
    </div>

    <!-- COMBINED IMPORTANCE -->
    <div class="section">
        <h2>Combined Feature Importance</h2>
        <p>Normalized combination of permutation importance and gradient attribution (when available).</p>

        <img src="tcn_interpretability/combined_importance_top25.png" alt="Combined Importance Top 25">
    </div>

    <!-- MODEL INTERPRETATION -->
    <div class="section">
        <h2>Model Interpretation & Business Insights</h2>

        <h3>Top Predictors of Churn (TCN)</h3>
        <ol>
            <li><strong>Current vs Recent Ratio (0.0135 importance):</strong> The ratio of current month activity to recent 3-month average is the strongest predictor. Values below 1.0 indicate declining activity.</li>
            <li><strong>Recent Transaction Months Active (0.0177 importance):</strong> Number of active months in the recent 3-month window. Lower values indicate inconsistent engagement.</li>
            <li><strong>Max Drawdown Count (0.0274 importance):</strong> Maximum drop from peak transaction count. Large drawdowns signal significant disengagement.</li>
            <li><strong>Acceleration Count (0.0278 importance):</strong> Rate of change in activity trend. Negative acceleration with declining activity = high risk.</li>
            <li><strong>Momentum (1-month) (0.0281 importance):</strong> Short-term activity change. Negative momentum indicates recent decline.</li>
        </ol>

        <h3>Feature Category Insights</h3>
        <ul>
            <li><strong>Current Month Features (3.78% AUC impact):</strong> Most critical group. TCN heavily relies on recent activity patterns.</li>
            <li><strong>Recent 3 Months Features (3.40% AUC impact):</strong> Provides essential context for understanding current activity levels.</li>
            <li><strong>Advanced Time-Series Features (1.06% AUC impact):</strong> Temporal patterns like drawdown, acceleration, and momentum add meaningful signal beyond simple aggregations.</li>
            <li><strong>Geo Features (0.05% impact):</strong> Minimal contribution, likely due to sparse data availability in the V3 dataset.</li>
            <li><strong>Dialog Features (-0.37% impact):</strong> Negative impact suggests these features may be noisy or too sparse to be useful.</li>
        </ul>

        <h3>TCN vs LightGBM: Key Differences</h3>
        <div class="info-box">
            <ul>
                <li><strong>TCN focuses more on temporal patterns:</strong> Advanced time-series features (drawdown, acceleration, momentum) are more important for TCN than for LightGBM.</li>
                <li><strong>TCN has better precision:</strong> 56.2% vs 50.3% for LightGBM, making it more suitable when false positives are costly.</li>
                <li><strong>TCN captures sequential dependencies:</strong> The temporal architecture allows TCN to learn patterns across the 3-month sequence that LightGBM cannot.</li>
                <li><strong>Both models agree on current month importance:</strong> Both TCN and LightGBM identify current month features as most critical.</li>
            </ul>
        </div>

        <h3>Recommendations</h3>
        <div class="warning-box">
            <strong>Action Items:</strong>
            <ul>
                <li><strong>Monitor Current vs Recent Ratio:</strong> This is the strongest predictor. Values below 0.8 should trigger alerts.</li>
                <li><strong>Track Activity Drawdowns:</strong> Customers experiencing significant drops from peak activity need immediate attention.</li>
                <li><strong>Watch for Negative Acceleration:</strong> Customers with declining activity that's accelerating downward are at highest risk.</li>
                <li><strong>Focus on Temporal Patterns:</strong> TCN's strength is in temporal patterns - leverage this by monitoring momentum and stability metrics.</li>
                <li><strong>Consider Removing Dialog Features:</strong> The ablation study suggests dialog features may be hurting performance - consider feature selection.</li>
            </ul>
        </div>
    </div>

    <!-- TECHNICAL DETAILS -->
    <div class="section">
        <h2>Technical Details</h2>
        <table class="feature-table">
            <tr>
                <td><strong>Model Type</strong></td>
                <td>Temporal Convolutional Network (TCN)</td>
            </tr>
            <tr>
                <td><strong>Architecture</strong></td>
                <td>Dilated causal convolutions with residual connections</td>
            </tr>
            <tr>
                <td><strong>Number of Features</strong></td>
                <td>71</td>
            </tr>
            <tr>
                <td><strong>Sequence Length</strong></td>
                <td>Variable (1-3 months per client)</td>
            </tr>
            <tr>
                <td><strong>Training Method</strong></td>
                <td>Early stopping on validation AUC (patience=15)</td>
            </tr>
            <tr>
                <td><strong>Best Validation AUC</strong></td>
                <td>0.9241</td>
            </tr>
            <tr>
                <td><strong>Test AUC</strong></td>
                <td>0.9109</td>
            </tr>
            <tr>
                <td><strong>Interpretability Methods</strong></td>
                <td>Permutation Importance, Gradient Attribution, Ablation Study</td>
            </tr>
            <tr>
                <td><strong>Permutation Sample Size</strong></td>
                <td>500 test samples</td>
            </tr>
        </table>
    </div>

</body>
</html>

